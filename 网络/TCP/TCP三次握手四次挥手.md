# TCP的三次握手与四次挥手

## 0、前置知识-TCP报文结构

![img](https://cdn.nlark.com/yuque/0/2022/png/23138217/1643296629359-07d6c76a-6109-43ca-9f85-5be57a15fa87.png)

32位序号-->seq

32位确认序号-->ack

- ACK(1位): 表示确认号字段有效
- SYN(1位): 新发起的报文
- FIN(1位): 结束连接的报文

## 1、三次握手四次挥手

![TCP连接与释放.drawio.png](https://cdn.nlark.com/yuque/0/2022/png/23138217/1643337996129-a426984c-5876-472c-a805-27641962591e.png) 

面试回答：

面试官你好，这个问题我是知道的。TCP/IP协议是传输层的一个面向连接的安全可靠的传输协议。

三次握手的机制是为了保证能建立一个安全可靠的连接；第一次握手是由客户端发起，客户端会向服务端发送一个报文，报文里面SYN标志位是置1的，当服务端收到这个报文的时候就知道客户端要和我发起一个新的连接，于是服务端就向客户端发送一个确认消息包ACK位置1，以上两次握手之后，对于客户端而言，其实是已经知道了所有信息，就是我既能给服务端发送消息，我还能收到服务端的消息；对于服务端而言，两次握手是不够的，因为到目前为止，服务端只知道一件事情，客户端给我发送的消息我收的到，但是我发给客户端的消息，客户端能不能收到我还不知道。

所以还要进行第三次握手。第三次握手就是当客户端收到服务端发过来的确认消息的报文之后，还要继续给服务端进行一个回应，也是一个ACK位置1的一个确认消息。

通过以上三次连接，不管是服务端还是客户端都彼此知道了，我既能给对方发送消息也能收到对方的消息，那么这个连接就能被安全的建立了。

四次握手机制，也是由客户端首先发起的，客户端会发起一个报文，在报文里面FIN标志位置1；当服务端收到这报文之后，我就知道了客户端想要和我断开连接，但是此时服务端不一定能做好准备，因为当客户端发起断开连接的时候，对于服务端而言它极有可能有未发送完的的消息，它还要继续发送；所以此时对于服务端而言他只能进行一个消息确认，我先告诉服务端，我知道你要和我断开连接了，但是我这还可能没有做好准备，你还需要等我一下，等会我会告诉你；于是，发完这个消息确认包后，可能稍作片刻，它可能会继续发送一个断开连接的报文，一个FIN位置1的报文，是由服务端发给客户端的，这个报文表示了服务端已经做好了断开连接的准备，那么当这个报文发给客户端的时候，客户端同样要给服务端继续发送一个消息确认的报文。一共有四次，通过这四次的相互沟通和连接，我就知道了，不管是服务端还是客户端都已经做好了断开连接的准备，于是连接就可以被断开了。

这是我对三次握手和四次挥手的理解。 

## 参考资料

- [【深度讲解+面试回答】tcp/ip协议三次握手、四次挥手，通俗易懂，亲自解答](https://www.bilibili.com/video/BV1bi4y1x7m5?from=search&seid=3851947783759497954&spm_id_from=333.337.0.0)